# 抓取进度功能优化方案

## 问题诊断

### 当前实现的问题
1. **数据库会话隔离**: 后台线程的 commit 可能不会立即被前端查询看到
2. **字段语义混乱**: `success_rows` 既表示"已抓取"又表示"已保存"
3. **缺少中间状态**: 无法区分"正在抓取"和"已完成"

### 根本原因

```python
# api_import_service.py 第 564 行
batch_record.success_rows = current_fetched_count  # ❌ 直接修改字段
db.commit()  # 可能被事务隔离
```

---

## ✅ 简单可靠方案

### 核心思路
使用 `import_metadata` JSON 字段存储实时进度,避免字段语义冲突

### 数据结构

```json
{
  "input_type": "category_id",
  "category_id": "172282",
  "domain": 1,
  "test_mode": false,
  "start_time": "2025-12-18T09:00:00",
  
  // 新增进度字段
  "progress": {
    "phase": "fetching_details",  // 当前阶段
    "current": 45,                 // 已完成数量
    "total": 100,                  // 总数量
    "percentage": 45,              // 百分比
    "message": "正在获取产品详情 (45/100)",
    "updated_at": "2025-12-18T09:01:30"
  }
}
```

### 阶段定义
1. `preparing` - 准备中 (0-10%)
2. `fetching_list` - 获取列表 (10-20%)
3. `fetching_details` - 获取详情 (20-90%)
4. `saving` - 保存数据 (90-95%)
5. `generating_excel` - 生成文件 (95-100%)
6. `completed` - 完成 (100%)

---

## 实现步骤

### 1. 创建进度管理工具类

```python
# backend/app/services/progress_tracker.py

from datetime import datetime
from typing import Optional
from sqlalchemy.orm import Session
from app.models.import_batch import ImportBatch

class ProgressTracker:
    """API 导入进度跟踪器"""
    
    PHASES = {
        "preparing": (0, 10),
        "fetching_list": (10, 20),
        "fetching_details": (20, 90),
        "saving": (90, 95),
        "generating_excel": (95, 100),
        "completed": (100, 100),
    }
    
    @staticmethod
    def update_progress(
        db: Session,
        batch_id: int,
        phase: str,
        current: int = 0,
        total: int = 0,
        message: Optional[str] = None
    ):
        """更新进度"""
        batch = db.get(ImportBatch, batch_id)
        if not batch:
            return
        
        # 计算百分比
        if phase in ProgressTracker.PHASES:
            phase_start, phase_end = ProgressTracker.PHASES[phase]
            if total > 0:
                phase_progress = (current / total) * (phase_end - phase_start)
                percentage = int(phase_start + phase_progress)
            else:
                percentage = phase_start
        else:
            percentage = 0
        
        # 更新 metadata
        if not batch.import_metadata:
            batch.import_metadata = {}
        
        batch.import_metadata["progress"] = {
            "phase": phase,
            "current": current,
            "total": total,
            "percentage": percentage,
            "message": message or f"{phase} ({current}/{total})",
            "updated_at": datetime.utcnow().isoformat()
        }
        
        # 同时更新状态
        if phase == "completed":
            batch.status = "succeeded"
        elif phase != "preparing":
            batch.status = "processing"
        
        db.commit()
```

### 2. 修改 API Import Service

```python
# 在 _fetch_details_batch 中使用
async def _fetch_details_batch(self, asins, domain, test_mode, db, batch_id):
    from app.services.progress_tracker import ProgressTracker
    
    total = len(asins)
    ProgressTracker.update_progress(
        db, batch_id, 
        phase="fetching_details",
        current=0, total=total,
        message=f"开始获取产品详情 (0/{total})"
    )
    
    # ... 处理逻辑 ...
    
    for i, batch in enumerate(batches):
        # ... API 调用 ...
        
        current_count = (i + 1) * batch_size
        ProgressTracker.update_progress(
            db, batch_id,
            phase="fetching_details",
            current=min(current_count, total),
            total=total,
            message=f"正在获取产品详情 ({current_count}/{total})"
        )
```

### 3. 修改前端状态获取

```typescript
// frontend API 响应
{
  "batch_id": 123,
  "status": "processing",
  "total_rows": 100,
  "success_rows": 45,
  "import_metadata": {
    "progress": {
      "phase": "fetching_details",
      "current": 45,
      "total": 100,
      "percentage": 52,  // 20 + (45/100 * 70)
      "message": "正在获取产品详情 (45/100)",
      "updated_at": "2025-12-18T09:01:30"
    }
  }
}
```

### 4. 前端进度显示

```vue
<script setup>
const getProgressInfo = (batch) => {
  const progress = batch.import_metadata?.progress
  
  if (!progress) {
    // 兼容旧数据
    if (batch.status === 'processing' && batch.total_rows > 0) {
      const pct = Math.round((batch.success_rows / batch.total_rows) * 100)
      return {
        percentage: pct,
        message: `处理中 (${batch.success_rows}/${batch.total_rows})`
      }
    }
    return { percentage: 0, message: '准备中...' }
  }
  
  return {
    percentage: progress.percentage,
    message: progress.message
  }
}
</script>
```

---

## 优势

✅ **简单**: 只用一个 JSON 字段,无需新增表或字段  
✅ **可靠**: 每次更新都是完整的 commit,避免部分更新  
✅ **灵活**: 可以随时添加新的进度信息(如预计剩余时间)  
✅ **兼容**: 不影响现有的 total_rows/success_rows 字段  
✅ **调试友好**: 所有进度信息集中在一个地方  

---

## 回滚方案

如果出现问题,只需:
1. 移除 ProgressTracker 调用
2. 前端回退到使用 success_rows/total_rows
3. 不影响数据库结构

---

## 测试要点

1. ✅ 进度从 0% 平滑增长到 100%
2. ✅ 每个阶段的百分比范围正确
3. ✅ 前端轮询能实时看到进度变化
4. ✅ 异常中断时进度信息仍然可读
5. ✅ 多个并发导入任务互不干扰
