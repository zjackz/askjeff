version: '3.8'

services:
  # ============================================================
  # Jeff Data Core (JDC) 服务
  # ============================================================

  jdc-api:
    build:
      context: .
      dockerfile: Dockerfile.jdc
    image: jeff-data-core:latest
    container_name: jdc-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://jdc_user:jdc_pass@jdc-postgres:5432/jdc_db
      - REDIS_URL=redis://:6379/0
      - LOG_LEVEL=INFO

      # Amazon API 配置
      - AMAZON_ADS_CLIENT_ID=${AMAZON_ADS_CLIENT_ID:-}
      - AMAZON_ADS_CLIENT_SECRET=${AMAZON_ADS_CLIENT_SECRET:-}
      - AMAZON_ADS_REFRESH_TOKEN=${AMAZON_ADS_REFRESH_TOKEN:-}
      - AMAZON_SP_CLIENT_ID=${AMAZON_SP_CLIENT_ID:-}
      - AMAZON_SP_CLIENT_SECRET=${AMAZON_SP_CLIENT_SECRET:-}
      - AMAZON_SP_REFRESH_TOKEN=${AMAZON_SP_REFRESH_TOKEN:-}
      - AMAZON_MARKETPLACE_ID=${AMAZON_MARKETPLACE_ID:-ATVPDKIKX0DER}

      # Sorftime API 配置
      - SORFTIME_API_KEY=${SORFTIME_API_KEY:-}

      # DeepSeek AI 配置
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - DEFAULT_AI_PROVIDER=${DEFAULT_AI_PROVIDER:-deepseek}

      # 日志配置
      - LOG_DIR=/app/logs

    volumes:
      - ./backend/storage:/app/storage
      - ./backend/logs:/app/logs
    depends_on:
      - jdc-postgres
      - jdc-redis

    networks:
      - jdc-network

  # ============================================================
  # PostgreSQL 数据库
  # ============================================================

  jdc-postgres:
    image: postgres:15-alpine
    container_name: jdc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: jdc_db
      POSTGRES_USER: jdc_user
      POSTGRES_PASSWORD: jdc_pass
      POSTGRES_INITDB_ARGS: "-E UTF8 -E 'LC_COLLATE=C'"
    volumes:
      - jdc-postgres-data:/var/lib/postgresql/data
      - jdc-postgres-backup:/var/lib/postgresql/backup
    networks:
      - jdc-network

  # ============================================================
  # Redis 缓存
  # ============================================================

  jdc-redis:
    image: redis:6-alpine
    container_name: jdc-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    environment:
      REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - jdc-redis-data:/data
    networks:
      - jdc-network

  # ============================================================
  # Grafana 监控（可选）
  # ============================================================

  jdc-grafana:
    image: grafana/grafana:latest
    container_name: jdc-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=${GRAFANA_ALLOW_SIGN_UP:-true}
      - GF_SERVER_ROOT_URL=http://jdc-grafana:3000
      - GF_INSTALL_PLUGINS=grafana-pyroscope
      - GF_DASHBOARD_JSON: /etc/grafana/provisioning/dashboards/jdc.json
    volumes:
      - jdc-grafana-data:/var/lib/grafana
    networks:
      - jdc-network
    depends_on:
      - jdc-postgres

volumes:
  jdc-postgres-data:
    driver: local
  jdc-redis-data:
    driver: local
  jdc-grafana-data:
    driver: local

networks:
  jdc-network:
    driver: bridge
