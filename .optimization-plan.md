# 全面代码优化计划

**创建时间**: 2025-12-18 11:03  
**工作模式**: 快速迭代模式  
**目标**: 全面优化项目代码质量

---

## 📊 代码质量分析结果

### ✅ 自动检查结果
- 检查文件数: 74
- 发现问题数: 0
- HTTP 超时: ✅ 已修复
- 分页限制: ✅ 正确配置
- 敏感数据: ✅ 已脱敏

### ⚠️ 发现的优化点

#### 1. 文件过长 (P2 - 技术债)

| 文件 | 行数 | 建议 |
|------|------|------|
| `services/sorftime/client.py` | 579 | 拆分为多个模块 |
| `services/api_import_service.py` | 670 | 拆分服务层 |
| `services/import_service.py` | 464 | 提取通用逻辑 |
| `services/ai/prompts.py` | 460 | 按功能拆分 |

**优先级**: P2 (可延后)  
**原因**: 功能正常,但影响可维护性

---

#### 2. TODO 注释 (P2 - 技术债)

**位置**:
- `services/ai/product_selection.py:207` - 从 CategoryTree 获取实际名称
- `services/ai/product_selection.py:283` - 实现趋势分析逻辑

**建议**: 
- 创建 GitHub Issue 跟踪
- 或在本次优化中实现

---

#### 3. 函数复杂度 (P1 - 影响质量)

**高复杂度函数**:
- `ChatService.ask()` - 100+ 行,多个职责
- `ImportRepository.list_products()` - 80+ 行,复杂查询逻辑
- `delete_all_data()` - 50+ 行,多个操作

**建议**: 提取子函数,降低复杂度

---

## 🎯 优化计划

### 阶段 1: 高优先级优化 (P1)

#### 任务 1.1: 重构复杂函数
- [ ] 重构 `ChatService.ask()` - 拆分为多个方法
- [ ] 重构 `ImportRepository.list_products()` - 提取查询构建逻辑
- [ ] 重构 `delete_all_data()` - 提取删除和重置逻辑

**预计时间**: 2 小时  
**优先级**: P1

---

#### 任务 1.2: 实现 TODO 功能
- [ ] 实现 CategoryTree 名称获取
- [ ] 实现趋势分析逻辑(或创建 Issue)

**预计时间**: 1 小时  
**优先级**: P1

---

### 阶段 2: 中优先级优化 (P2)

#### 任务 2.1: 拆分过长文件
- [ ] 拆分 `api_import_service.py` (670 行)
- [ ] 拆分 `sorftime/client.py` (579 行)
- [ ] 拆分 `ai/prompts.py` (460 行)

**预计时间**: 3 小时  
**优先级**: P2

---

#### 任务 2.2: 代码规范化
- [ ] 统一错误处理模式
- [ ] 统一日志记录格式
- [ ] 添加缺失的类型注解

**预计时间**: 2 小时  
**优先级**: P2

---

### 阶段 3: 测试与文档 (P1)

#### 任务 3.1: 补充测试
- [ ] 为重构的函数添加单元测试
- [ ] 为复杂逻辑添加集成测试

**预计时间**: 2 小时  
**优先级**: P1

---

#### 任务 3.2: 更新文档
- [ ] 更新 API 文档
- [ ] 更新 README
- [ ] 补充代码注释

**预计时间**: 1 小时  
**优先级**: P2

---

## 🔍 AGENTS 体系验证

### ✅ 有效的部分
1. **自动检查工具** - 快速扫描了 74 个文件
2. **自检清单** - 指导了手动审查
3. **优化模式文档** - 提供了重构参考

### ⚠️ 发现的不足

#### 不足 1: 缺少复杂度检查
**问题**: 自动检查工具没有检测函数复杂度和文件长度

**建议**: 扩展 `check_code_quality.py`

```python
# 添加检查项
- 检查函数行数 (> 80 行警告)
- 检查文件行数 (> 300 行警告)
- 检查 TODO 注释
- 检查循环复杂度
```

**优先级**: P1

---

#### 不足 2: 缺少重构指南
**问题**: 优化模式文档缺少具体的重构步骤

**建议**: 创建 `AGENTS/refactoring-guide.md`
- 重构前检查清单
- 重构步骤模板
- 测试验证方法

**优先级**: P2

---

#### 不足 3: 缺少代码度量
**问题**: 没有代码质量度量工具

**建议**: 集成代码度量工具
- 使用 `radon` 计算复杂度
- 使用 `pylint` 评分
- 生成质量报告

**优先级**: P2

---

## 📋 执行策略

### 立即执行 (本次优化)
1. ✅ 扩展自动检查工具 (添加复杂度检查)
2. ✅ 重构 1-2 个高复杂度函数
3. ✅ 创建重构指南文档
4. ✅ 补充测试

### 本周执行
1. 完成所有 P1 任务
2. 创建 GitHub Issues 跟踪 TODO
3. 更新文档

### 本月执行
1. 完成所有 P2 任务
2. 拆分过长文件
3. 集成代码度量工具

---

## 🎯 成功标准

### 代码质量
- [ ] 所有函数 ≤ 80 行
- [ ] 所有文件 ≤ 300 行
- [ ] 无 P0/P1 问题
- [ ] 测试覆盖率 ≥ 60%

### AGENTS 体系
- [ ] 自动检查工具覆盖所有检查项
- [ ] 文档完整且实用
- [ ] 有清晰的重构指南

---

## 下一步行动

1. 扩展自动检查工具
2. 重构 `ChatService.ask()`
3. 创建重构指南
4. 补充测试
