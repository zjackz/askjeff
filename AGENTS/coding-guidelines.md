# AI 通用编程指南（模板）

> 建议放置位置：项目根目录 `AGENTS/`（便于跨项目复制）。

## MUST（开始前先确认；不清晰就提问）

- 目标与输出物（接口/页面/脚本/文档）
- 验收标准（≥3 条，含失败与边界）
- 约束（运行环境/联网/依赖与数据库/破坏性操作）
- 非目标（明确“不做什么”）

## MUST（默认执行步骤）

1) 读最近的 `AGENTS.md`（子目录优先）  
2) 用 `rg` 找入口与调用链，优先修根因  
3) 小步实现，保持 diff 最小，避免无关重构  
4) 先拆分再堆代码（见“规模控制”）  
5) 必须补测试（至少覆盖成功与失败）  
6) 必须跑 `lint`/`test`/`build`（先小后大）  
7) 交付说明：改动点/影响/验证命令/风险与回滚  

## MUST NOT（安全红线）

- 禁止硬编码密钥/Token/口令；禁止“可用默认值”；缺失必须 fail fast 并给中文提示
- 禁止日志/错误信息泄露密钥、PII、内部地址；只输出脱敏摘要与可排障上下文
- 禁止“猜测式修复”线上/联调问题；必须先查日志/复现/最小化用例
- 破坏性命令必须二次确认（清库、回滚、批量重写、`rm -rf`、`git reset --hard`）

## MUST（规模控制：防单文件爆炸）

- 页面/组件 ≤ 300 行（> 500 必须拆分）；路由/控制器 ≤ 300 行（> 500 必须拆分）；单函数 ≤ 80 行（> 120 必须拆分）
- 拆分优先级：UI → `components/`；状态/副作用 → `stores/`/`composables`（或 `services/`）；API 调用 → `src/api/`（或 `api/clients/`）
- 预计会超阈值：必须先输出“拆分清单（路径+职责）”，再开始写代码

## MUST（接口契约与错误码）

- 契约唯一来源：OpenAPI/接口文档；调用方不得猜路径/字段名或依赖代理 rewrite
- 版本前缀必须单一（如 `/api/v1`）；兼容旧路径必须给映射表与下线日期
- 必须维护错误码表（命名规则 + HTTP 映射 + 前端提示策略）；新增错误必须登记

## MUST（外部 API 客户端）

- 同一外部服务只能有一个客户端实现（超时/重试/退避/错误映射/日志字段/脱敏策略统一）
- 失败必须可排障：记录 `raw_response` 摘要 + 参数摘要 + 状态码 + 耗时 + 请求标识

## MUST（停止条件）

- 缺关键配置/密钥且无法安全提供：停止并说明如何配置；不得用临时默认值继续
- 接口前缀/错误结构多套并行且无迁移计划：停止并要求补齐策略
- 无法运行测试/静态检查：说明原因 + 提供替代验证，并在交付中标明风险

## 项目占位符（复制后填写）

- 启动：`<...>`
- 测试：`<...>`
- 静态检查：`<...>`
- 构建/发布：`<...>`

---

## AI 自检清单(提交前必查)

### 后端代码

**数据安全**
- [ ] 所有数据库操作都有异常处理(try-except 或 dependency 注入)
- [ ] 外部 API 调用都有超时设置(默认 30s,最大 60s)
- [ ] 敏感数据(密码、Token、API Key)已脱敏记录
- [ ] 用户输入都经过 Pydantic 验证
- [ ] SQL 查询使用参数化,无字符串拼接

**数据完整性**
- [ ] 新增数据库字段有默认值或迁移脚本处理旧数据
- [ ] 删除操作有软删除或二次确认
- [ ] 批量操作有事务保护
- [ ] 分页查询有最大限制(max 200)
- [ ] 文件上传有大小(max 10MB)和类型校验

**可观测性**
- [ ] 关键业务逻辑有日志记录(info 级别)
- [ ] 错误处理有完整上下文(error 级别 + context)
- [ ] 外部 API 调用记录了 duration_ms 和 raw_response
- [ ] 异步任务有状态跟踪

**性能**
- [ ] 数据库查询有索引(检查 EXPLAIN)
- [ ] N+1 查询已优化(使用 joinedload/selectinload)
- [ ] 大数据量操作使用分批处理
- [ ] 缓存策略已考虑(如适用)

### 前端代码

**用户体验**
- [ ] 所有 API 调用都有 loading 状态
- [ ] 表单提交有防重复点击(loading 或 disabled)
- [ ] 错误提示是中文且可执行(如"请检查网络连接"而非"Network Error")
- [ ] 列表有空状态提示("暂无数据"而非空白)
- [ ] 长文本有截断或 tooltip

**数据展示**
- [ ] 时间格式统一(YYYY-MM-DD HH:mm:ss)
- [ ] 数字格式统一(千分位、小数位)
- [ ] 状态使用统一的枚举值和颜色
- [ ] 表格有分页(page-sizes: [20, 50, 100, 200])
- [ ] 表格操作列固定在右侧

**交互反馈**
- [ ] 危险操作有二次确认弹窗
- [ ] 成功提示克制(优先用状态更新替代 toast)
- [ ] 表单校验有首错聚焦
- [ ] 按钮文案统一(新增/保存/导入/导出/重试)

### 通用检查

**代码质量**
- [ ] 函数长度 ≤ 80 行(超过需拆分)
- [ ] 文件长度 ≤ 300 行(超过需拆分)
- [ ] 无硬编码魔法数字(使用常量或配置)
- [ ] 无重复代码(DRY 原则)
- [ ] 变量命名清晰(避免 a, b, tmp 等)

**文档与注释**
- [ ] 复杂逻辑有中文注释说明
- [ ] 公共 API 有文档字符串
- [ ] TODO 已记录在 tasks.md 或创建 issue
- [ ] Commit 信息符合规范(feat/fix/docs/test/refactor/chore)

**测试**
- [ ] 新增 API 端点有集成测试
- [ ] 核心业务逻辑有单元测试
- [ ] 测试覆盖成功和失败场景
- [ ] 所有测试通过(pytest/lint)
