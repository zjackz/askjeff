# 代码审查模板

> 标准化的代码审查流程,确保代码质量和一致性。

**使用场景**: Pull Request 审查、代码合并前检查、定期代码审查

---

## 📋 审查清单

### 1. 功能性 (P0 - 必须检查)

- [ ] **功能完整性**: 代码实现了所有需求
- [ ] **边界条件**: 处理了空值、边界值、异常输入
- [ ] **错误处理**: 所有可能的错误都有适当处理
- [ ] **测试覆盖**: 有单元测试和集成测试

### 2. 安全性 (P0 - 必须检查)

- [ ] **输入验证**: 所有用户输入都经过 Pydantic 验证
- [ ] **SQL 注入**: 使用参数化查询,无字符串拼接
- [ ] **敏感数据**: 密码、Token、API Key 已脱敏记录
- [ ] **权限检查**: 有适当的权限控制(RBAC)

### 3. 性能 (P1 - 重要)

- [ ] **数据库查询**: 有索引,无 N+1 查询
- [ ] **分页**: 大数据量操作使用分页(max 200)
- [ ] **缓存**: 适当使用缓存(如适用)
- [ ] **异步处理**: 耗时操作使用后台任务

### 4. 可观测性 (P1 - 重要)

- [ ] **日志记录**: 关键业务逻辑有日志
- [ ] **错误日志**: 错误有完整上下文
- [ ] **监控指标**: 关键操作有指标记录

### 5. 代码质量 (P2 - 建议)

- [ ] **命名规范**: 变量、函数名清晰易懂
- [ ] **代码复用**: 无重复代码(DRY 原则)
- [ ] **函数长度**: 函数 ≤ 80 行,文件 ≤ 300 行
- [ ] **注释**: 复杂逻辑有中文注释

### 6. 文档 (P2 - 建议)

- [ ] **API 文档**: 新端点有文档字符串
- [ ] **README**: 重要功能更新了 README
- [ ] **Changelog**: 记录了变更内容

---

## 🎯 审查流程

### 第一轮:快速扫描 (5 分钟)

1. **查看文件列表** - 了解改动范围
2. **查看 Commit 信息** - 理解改动意图
3. **运行自动检查** - `python scripts/check_code_quality.py`

### 第二轮:详细审查 (15-30 分钟)

1. **逐文件审查** - 按照审查清单检查
2. **运行测试** - 确保所有测试通过
3. **本地验证** - 拉取代码本地测试

### 第三轮:反馈与讨论 (10 分钟)

1. **记录问题** - 使用下面的反馈模板
2. **讨论方案** - 与作者讨论修改方案
3. **确认修复** - 验证问题已解决

---

## 💬 反馈模板

### 严重问题 (P0 - 必须修复)

```markdown
🔴 **[严重] 标题**

**位置**: `文件名:行号`

**问题**: 简短描述问题

**影响**: 说明可能的影响

**建议**: 提供修复建议或参考链接

**参考**: AGENTS/common-pitfalls.md#问题X
```

### 一般问题 (P1/P2 - 建议修复)

```markdown
⚠️  **[建议] 标题**

**位置**: `文件名:行号`

**问题**: 简短描述

**建议**: 修复建议
```

### 优点表扬

```markdown
✅ **做得好!**

**位置**: `文件名:行号`

**亮点**: 说明好的地方
```

---

## 🚫 常见问题

### 1. HTTP 超时未配置

❌ **错误**:

```python
async with httpx.AsyncClient() as client:
    response = await client.post(url, json=data)
```

✅ **正确**:

```python
async with httpx.AsyncClient(timeout=httpx.Timeout(30.0)) as client:
    response = await client.post(url, json=data)
```

### 2. 分页无上限

❌ **错误**:

```python
page_size: int = Query(default=20)
```

✅ **正确**:

```python
page_size: int = Query(default=20, ge=1, le=200)
```

### 3. 敏感数据未脱敏

❌ **错误**:

```python
logger.info(f"User login: {username}, password: {password}")
```

✅ **正确**:

```python
logger.info(f"User login: {username}, password: ***")
```

---

## 📊 审查结果

### 通过标准

- ✅ 所有 P0 问题已修复
- ✅ 所有测试通过
- ✅ 代码符合项目规范

### 拒绝标准

- ❌ 存在 P0 严重问题
- ❌ 测试未通过
- ❌ 代码质量严重不符合规范

---

## 🔗 参考资料

- [编码规范](coding-guidelines.md) - 自检清单
- [常见陷阱](common-pitfalls.md) - 已知问题
- [测试规范](testing-guidelines.md) - 测试要求
