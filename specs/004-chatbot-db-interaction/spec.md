# 需求规格说明书：Chatbot 数据库交互 (004)

## 1. 背景与目标

目前的 Chatbot 仅能基于静态的统计数据（批次总数、最新批次行数）进行回答，无法响应用户关于具体业务数据的查询（如“销量前十的产品”、“昨天的日志错误”）。

本需求的目标是赋予 Chatbot 与数据库交互的能力，使其能够理解用户意图，自动查询数据库，并基于查询结果生成准确的自然语言回答。

## 2. 核心功能

### 2.1 意图识别与工具调用
- Chatbot 能够识别用户查询数据的意图。
- Chatbot 能够根据用户问题，选择合适的工具（Function）并提取参数。
- 支持的工具包括但不限于：
  - `query_products`: 查询产品列表（支持关键词、排序、分页）。
  - `get_batch_status`: 查询指定批次的状态和详情。
  - `analyze_logs`: 查询和分析系统日志。

### 2.2 数据查询与回答生成
- 后端能够解析 Chatbot 返回的工具调用指令。
- 后端执行相应的工具函数，从数据库获取实时数据。
- Chatbot 能够根据工具返回的数据（Context），生成最终的自然语言回答。

### 2.3 安全性
- 禁止直接 Text-to-SQL，防止 SQL 注入和非授权访问。
- 所有数据库查询必须通过预定义的 Service 方法进行，确保权限控制。

## 3. 用户故事

- **用户**：作为一名数据分析师
- **操作**：我在聊天窗口输入“帮我查一下销量最高的 5 个产品”
- **期望**：Chatbot 回复“为您查询到销量最高的 5 个产品，分别是 A, B, C...，其中 A 的销量排名为 1，价格为...”

- **用户**：作为一名运维人员
- **操作**：我在聊天窗口输入“查看批次 batch-20231201 的状态”
- **期望**：Chatbot 回复“批次 batch-20231201 当前状态为‘已完成’，共导入 1000 条数据，无错误。”

## 4. 约束条件

- 必须使用 DeepSeek 模型。
- 必须保持现有的技术栈（FastAPI + SQLAlchemy）。
- 响应时间应在可接受范围内（考虑到多次 LLM 调用，需优化 Prompt）。
