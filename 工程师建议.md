# AskJeff 工程质量评估与改进建议（工程师建议）

**生成时间**：2025-12-17  
**评估范围**：`frontend/`（Vue 3 + TS + Vite）、`backend/`（FastAPI + Pydantic v2 + SQLAlchemy 2）  
**评估方式**：静态代码审阅 + 仓库结构与依赖盘点 + 关键链路抽样（鉴权/错误处理/日志/AI 接口/导入导出）  

> 说明：本次评估未能在当前执行环境中完整跑通 `pnpm lint/test` 与 Docker 容器内 `pytest/ruff`（原因是工具链/daemon 不可用），因此结论以“静态证据 + 工程经验”给出。建议后续在标准 Docker Compose 开发环境中复验。

---

## 给 AI 的编程指南（简要执行清单）

> 目标：让后续任何 AI 在本仓库改代码时，按固定步骤执行，避免重复踩坑（配置泄露、接口不一致、无测试、盲改不查日志）。

### 0）开始前（3 分钟内做完）
- 只在 `main` 分支小步改动；先确认需求来源：`specs/README.md` / 对应 `specs/00X-*/`。
- 先读本仓库 `AGENTS.md`：**必须中文**；后端开发/测试优先走 **Docker Compose**。
- 明确本次改动范围：`frontend/` 或 `backend/`；列出“改哪些文件/新增哪些接口/需要哪些测试”。

### 1）安全与配置（P0，先做再写业务）
- 禁止在代码里出现任何真实 Key/Token/密钥默认值；必须从环境变量读取，缺失时 **启动直接失败** 并给中文提示。
- 日志里禁止写入密钥明文；`context` 里只放脱敏后的可排障信息。

### 2）接口一致性（避免前后端对不上）
- API 前缀与版本必须全仓一致（建议统一 `/api/v1`）；前端 `API_BASE`、后端路由 `prefix`、网关转发规则要对应。
- 错误响应只保留一套结构（建议 `{error:{code,message,details}}`）；前端只写一套解析逻辑。

### 3）遇到问题先查日志（禁止“猜测式修复”）
- 任何“抓取失败/解析异常/接口报错”，第一步查 `system_logs`（最近 10–30 分钟），再决定改哪里。
- 需要复用的查询命令优先写到脚本或文档，避免口口相传。

### 4）实现方式（少踩坑的默认做法）
- 前端：新接口统一放 `frontend/src/api/`；页面逻辑优先下沉到 `stores/` 或 `composables/`；避免超大 SFC（目标：主页面 ~300 行）。
- 后端：路由只做参数/返回模型与权限；业务放 `app/services/`；外部 API 调用统一客户端实现，避免重复文件漂移。

### 5）验证（必须可复现）
- 前端：`pnpm --prefix frontend lint`
- 后端（优先 Docker）：`docker exec askjeff-dev-backend-1 poetry run pytest tests/` 与 `docker exec askjeff-dev-backend-1 poetry run ruff check`
- 中文合规：`python scripts/check_cn.py`
- 新增/修改的 API 必须补测试（至少 1 个集成测试）；核心 Service 必须补单元测试。

### 6）交付（减少返工）
- 变更说明写清楚：改动点、兼容策略、如何验证（命令）、影响范围与回滚方式。
- 提交信息按规范：`feat(编号): ...` / `fix(编号): ...` / `docs: ...` / `test: ...`。

## 1. 总体结论（可执行摘要）

### 1.1 当前工程质量画像

- **基础架构方向正确**：前后端分层基本清晰，后端 `services/` 与 `api/routes/` 结构可持续扩展；具备一定测试基础（`backend/tests/` 已存在较多用例）。
- **质量风险集中在三类**：
  1) **安全与配置**：存在明文默认密钥/第三方 Key 写在代码中，属于高危隐患。  
  2) **接口一致性**：前后端 API 前缀/版本与错误响应格式存在“多套并行”，长期必然带来线上故障与联调成本。  
  3) **可维护性**：前端存在“超大单文件组件”和重复实现，后端也有重复客户端实现，未来改动的回归成本会快速上升。

### 1.2 优先级路线（建议）

- **P0（本周必须）**：移除默认密钥/Key；统一 API 路由前缀与版本；统一错误响应与前端处理逻辑。
- **P1（两周内）**：拆分前端巨型页面；减少 `any`/不必要的 `except Exception`；完善 lint/CI 可复现。
- **P2（一个月内）**：标准化工程规范落地（CI、提交门禁、代码结构约束、文档与脚手架）。

---

## 2. 发现与证据（按严重程度）

### P0-1：代码中存在默认密钥/第三方 Key（高危）

**现象**  
- `backend/app/config.py:28`：`SORFTIME_API_KEY` 提供了默认值。  
- `backend/app/config.py:34`：`SECRET_KEY` 提供了默认值。  

**风险**  
- 代码一旦外泄/误提交/日志打印/镜像分发，密钥将不可控扩散。
- 默认密钥会导致不同环境“看似可用但不安全”，很容易在生产遗留。
- 安全事件发生后，影响范围包括：用户身份伪造、越权访问、外部 API 额度/费用损失。

**建议（明确可执行）**  
1) **移除默认值**：`SORFTIME_API_KEY`、`SECRET_KEY`、`DEEPSEEK_API_KEY` 均不应有真实默认值。  
2) **启动时强校验**：应用启动时若缺失关键配置，直接 fail fast，并输出中文错误提示。  
3) **输出脱敏**：任何日志/异常信息都不应输出密钥明文（目前 `LogService` 有脱敏，但仍需避免把敏感数据写入 `context`）。  

**验收标准**  
- 无任何密钥/Token 以默认值形式出现在仓库中；缺失时服务明确启动失败并提示如何配置。

---

### P0-2：前后端 API 路径版本不一致，存在“隐性依赖代理”的风险

**现象（抽样）**  
- 前端 `frontend/src/utils/http.ts:6`：`API_BASE = '/api'`。  
- 前端 `frontend/src/api/ai.ts:42`：调用 `POST '/ai/product-selection'`，最终请求为 `/api/ai/product-selection`。  
- 后端 `backend/app/main.py:118`：AI 路由挂载在 `prefix="/api/v1/ai"`，端点为 `/api/v1/ai/product-selection`。  

**风险**  
- 在某些环境（Nginx/网关/代理规则变更）下会直接 404。
- 前端接口路径与后端路由不一致，导致联调依赖“环境配置碰巧补齐”，不可控。

**建议（明确可执行）**  
给出两种方案，建议选其一并全仓统一：

- **方案 A（推荐）**：前端统一使用 `/api/v1` 作为前缀；后端路由按 `/api/v1/*` 组织；网关仅需转发 `/api`→后端即可。  
- **方案 B**：后端兼容旧路径（新增 `/api/ai/*` 的 alias 路由或重挂载），并逐步迁移前端到 `/api/v1`，最终移除旧路径。  

**验收标准**  
- 前端所有请求的前缀与后端实际路由一致，不再依赖“代理额外 rewrite”才能工作。  

---

### P0-3：全局错误处理机制重复且响应格式不统一，前端被迫写兼容逻辑

**现象**  
- 后端中间件统一错误响应：`backend/app/middleware/error_handler.py:95` 返回 `{ "error": { "code": ..., "message": ..., "details": ... } }`。  
- 同时注册了异常处理器：`backend/app/api/errors.py:14` 返回 `{ "message": "..." }`。  
- 前端为兼容两种格式，写了多分支处理：`frontend/src/utils/http.ts:117`。  

**风险**  
- 线上错误提示不可预测：不同异常路径产生不同 JSON 结构。
- 前端错误处理越来越复杂，最终出现“某类错误不提示/提示错误/重复提示”的 UX 问题。

**建议（明确可执行）**  
1) 后端只保留一套“统一错误响应格式”，建议以 `{error:{code,message,details}}` 为唯一标准。  
2) 将 `HTTPException`（如鉴权失败、参数错误）也纳入统一格式，避免不同端点散落返回。  
3) 前端 `http.ts` 只处理统一格式，其余作为兜底分支（极少触发）。  

**验收标准**  
- 任意异常（验证/业务/系统/鉴权）都返回同一 JSON 结构；前端无需“多格式兼容”才能稳定提示。

---

## 3. P1 级问题（影响迭代效率与长期维护）

### P1-1：前端存在超大单文件组件（维护成本高）

**证据（规模）**  
- `frontend/src/views/admin/SorftimeTest.vue`：约 2779 行。  
- `frontend/src/views/import/index.vue`：约 1453 行。  
- `frontend/src/views/extraction/index.vue`：约 954 行。  

**风险**  
- 代码可读性差、难测试、回归风险高；多人协作冲突概率大。
- 小改动也容易触发大范围 UI/状态副作用，导致“修一处坏三处”。

**建议（明确可执行）**  
- 按“领域组件化”拆分：请求编辑区/响应展示/历史记录/快捷键/统计面板等独立组件；把 API 调用与状态管理下沉到 `stores` 或 `composables`。  
- 形成目录级约束：例如 `views/admin/sorftime-test/*` 归档子组件，避免继续膨胀。  

**验收标准**  
- 核心页面拆分后主页面文件控制在 ~300 行量级；状态与请求逻辑可被单测/组件测试覆盖。  

---

### P1-2：UI 规范未统一落地（Element Plus size、分页规格等）

**现象（抽样）**  
- 多处 `size="small"`：例如 `frontend/src/views/admin/SorftimeTest.vue:8`、`frontend/src/views/logs/index.vue` 等。  
- 分页规格不一致：`frontend/src/views/chat/index.vue:256` 使用 `[10, 20, 50, 100]`，而规范要求 `[20, 50, 100, 200]`。  

**风险**  
- 产品一致性差、维护成本高；后续 UI 调整需要全仓手工改。

**建议（明确可执行）**  
- 仅允许“表格行内/极紧凑场景”使用 `small`，其余回归默认尺寸。  
- 分页统一：`page-sizes` 固定为 `[20, 50, 100, 200]`，默认 50。  
- 增加 ESLint/Vue 规则或自定义检查脚本（仓库已有 `scripts/`）避免回退。  

---

### P1-3：中英文混用，偏离“全部中文”规范

**现象（抽样）**  
- 前端注释：`frontend/src/stores/user.ts:15` 为英文。  
- 后端文档字符串/错误信息：`backend/app/api/routes/imports.py:124` 为英文；`backend/app/api/v1/endpoints/ai.py:35` 错误信息为英文。  

**风险**  
- 团队协作沟通成本增加；与现有规范不一致导致代码风格漂移。

**建议（明确可执行）**  
- 统一将用户可见文案、注释、docstring 改为中文（保留必要术语）。  
- 在 PR 模板/CI 中加入“中文合规检查”（仓库已有 `python scripts/check_cn.py` 的约定，可纳入门禁）。  

---

### P1-4：后端存在重复/漂移的客户端实现

**现象**  
- `backend/app/services/deepseek_client.py` 与 `backend/app/services/ai/deepseek_client.py` 同时存在。  

**风险**  
- 两套实现的参数、重试、错误处理、日志字段可能逐渐分叉，导致线上行为不一致且难排障。

**建议（明确可执行）**  
- 收敛为单一客户端（建议放在 `app/services/ai/clients/` 或 `app/services/clients/`），统一：超时、重试、错误码映射、日志字段、脱敏策略。  

---

## 4. P2 级建议（工程化与可复现）

### P2-1：可复现性与本地/容器一致性需要补齐

**现象**  
- 前端本机执行 `pnpm lint/test` 失败，原因是 `frontend/node_modules/.bin/eslint` 写死容器路径 `/app`（`frontend/node_modules/.bin/eslint:13`），说明依赖安装方式与运行方式不一致。  

**
建议（明确可执行）**  
- 明确“前端是否也必须在容器内执行 lint/test”。若是，提供统一命令（例如 `make frontend-lint` 走容器）。  
- 若允许本机执行，确保 `pnpm install` 在本机可生成正确的 `node_modules`，不要提交容器内生成的 `node_modules` 结果到工作区。  

---

### P2-2：静态检查配置过轻，缺少统一门禁

**现状**  
- `backend/ruff.toml` 配置非常少。  

**建议（明确可执行）**  
- 补齐 Ruff 规则集并在 CI/Docker 中固定执行。  
- 建议门禁策略：`ruff check` + `pytest` + 前端 `pnpm lint` 必须全绿才允许合并。  

---

## 5. 建议的实施计划（按投入产出排序）

### 5.1 第 1 阶段（P0，本周）
1) 移除 `backend/app/config.py` 中所有默认密钥/Key，增加启动时校验与中文提示。  
2) 统一 API 前缀策略（推荐 `/api/v1`），调整前端 `API_BASE` 与各 API 封装路径。  
3) 后端只保留一套错误返回结构，清理重复异常处理器/重复路由注册点；前端 `http.ts` 精简为“单一错误格式”。  

### 5.2 第 2 阶段（P1，两周内）
1) 拆分 `SorftimeTest.vue`、`import/index.vue`、`extraction/index.vue`：组件化 + 逻辑下沉。  
2) 统一 UI 尺寸与分页规格，引入自动化检查避免回退。  
3) 收敛 DeepSeek 客户端实现，统一日志字段与异常语义。  

### 5.3 第 3 阶段（P2，一个月内）
1) 建立 CI/门禁：前后端 lint/test 一键跑通；引入中文合规检查。  
2) 形成“新页面/新服务的模板与目录约束”，减少随意堆叠。  

---

## 6. 需要团队确认的决策点（建议尽快拍板）

1) **API 版本策略**：是否全面采用 `/api/v1` 并淘汰旧前缀？（推荐是）  
2) **前端运行策略**：前端 lint/test 是否也必须容器化执行？若必须，需要补齐 `make` 命令与文档。  
3) **错误响应标准**：是否以 `{error:{code,message,details}}` 作为唯一标准并全链路统一？（推荐是）  

---

## 7. 下一步（我可以直接推进的工作）

如果你同意，我建议从 P0 开始出第一批改动，目标是“安全 + 接口一致性 + 错误统一”三件事一次性落地，并补齐对应测试与验证命令。
